# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

extraSecrets:
  eos-csi-file-etc-eos-keytab:
    stringData:
      eos.keytab: |
        0 u:eosnobody g:def-cg n:eosnobody N:6752069312392986625 c:1572088644 e:0 f:0 k:ea3d35d2dd64ad4794a2e2f7499fd3c45e0e8a590b0c4ff8a2049cbec244636c

# Extra ConfigMaps to create and manage by the chart release.
# These can be used e.g. when defining eosxd client configuration.
# ConfigMap data supports go-template expressions.
extraConfigMaps:
  eos-csi-dir-etc-auto-master-d:
    eos.autofs: |
      /eos /etc/auto.eos
  eos-csi-file-etc-auto-eos:
    auto.eos: |
      ams -fstype=eosx,fsname=ams  :eosxd
      atlas -fstype=eosx,fsname=atlas  :eosxd
      cms -fstype=eosx,fsname=cms  :eosxd
      experiment -fstype=eosx,fsname=experiment  :eosxd
      geant4 -fstype=eosx,fsname=geant4  :eosxd
      lhcb -fstype=eosx,fsname=lhcb  :eosxd
      project -fstype=eosx,fsname=project  :eosxd
      theory -fstype=eosx,fsname=theory  :eosxd
      user -fstype=eosx,fsname=user  :eosxd
      web -fstype=eosx,fsname=web  :eosxd
      workspace -fstype=eosx,fsname=workspace  :eosxd

      # EOS instance-letter mappings are defined in their respective
      # client configs in /etc/eos.

      home-i00 -fstype=eosx,fsname=home-i00  :eosxd
      home-i01 -fstype=eosx,fsname=home-i01  :eosxd
      home-i02 -fstype=eosx,fsname=home-i02  :eosxd
      home-i03 -fstype=eosx,fsname=home-i03  :eosxd
      home-i04 -fstype=eosx,fsname=home-i04  :eosxd

      home-d :home-i00/d
      home-l :home-i00/l
      home-n :home-i00/n
      home-t :home-i00/t
      home-z :home-i00/z

      home-a :/eos/home-i01/a
      home-g :/eos/home-i01/g
      home-j :/eos/home-i01/j
      home-k :/eos/home-i01/k
      home-w :/eos/home-i01/w

      home-h :/eos/home-i02/h
      home-o :/eos/home-i02/o
      home-r :/eos/home-i02/r
      home-s :/eos/home-i02/s
      home-y :/eos/home-i02/y

      home-b :/eos/home-i03/b
      home-e :/eos/home-i03/e
      home-m :/eos/home-i03/m
      home-v :/eos/home-i03/v
      home-x :/eos/home-i03/x

      home-c :/eos/home-i04/c
      home-f :/eos/home-i04/f
      home-i :/eos/home-i04/i
      home-p :/eos/home-i04/p
      home-q :/eos/home-i04/q
      home-u :/eos/home-i04/u

      project-i00 -fstype=eosx,fsname=project-i00  :eosxd
      project-i01 -fstype=eosx,fsname=project-i01  :eosxd
      project-i02 -fstype=eosx,fsname=project-i02  :eosxd

      project-a :/eos/project-i00/a
      project-e :/eos/project-i00/e
      project-j :/eos/project-i00/j
      project-g :/eos/project-i00/g
      project-v :/eos/project-i00/v
      project-k :/eos/project-i00/k
      project-q :/eos/project-i00/q
      project-y :/eos/project-i00/y

      project-l :/eos/project-i01/l
      project-h :/eos/project-i01/h
      project-b :/eos/project-i01/b
      project-p :/eos/project-i01/p
      project-s :/eos/project-i01/s
      project-f :/eos/project-i01/f
      project-w :/eos/project-i01/w
      project-n :/eos/project-i01/n
      project-o :/eos/project-i01/o

      project-d :/eos/project-i02/d
      project-c :/eos/project-i02/c
      project-i :/eos/project-i02/i
      project-r :/eos/project-i02/r
      project-m :/eos/project-i02/m
      project-t :/eos/project-i02/t
      project-u :/eos/project-i02/u
      project-x :/eos/project-i02/x
      project-z :/eos/project-i02/z

  eos-csi-dir-etc-eos:
    fuse.conf: |
      {"auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.ams.conf: |
      {"name":"ams","hostport":"eosams.cern.ch","remotemountdir":"/eos/ams/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.atlas.conf: |
      {"name":"atlas","hostport":"eosatlas.cern.ch","remotemountdir":"/eos/atlas/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.cms.conf: |
      {"name":"cms","hostport":"eoscms.cern.ch","remotemountdir":"/eos/cms/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.experiment.conf: |
      {"name":"experiment","hostport":"eospublic.cern.ch","remotemountdir":"/eos/experiment/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.geant4.conf: |
      {"name":"geant4","hostport":"eospublic.cern.ch","remotemountdir":"/eos/geant4/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.home-i00.conf: |
      {"name":"home-i00","hostport":"eoshome-i00.cern.ch","remotemountdir":"/eos/user/","bind":"d l n t z","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.home-i01.conf: |
      {"name":"home-i01","hostport":"eoshome-i01.cern.ch","remotemountdir":"/eos/user/","bind":"a g j k w","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.home-i02.conf: |
      {"name":"home-i02","hostport":"eoshome-i02.cern.ch","remotemountdir":"/eos/user/","bind":"h o r s y","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.home-i03.conf: |
      {"name":"home-i03","hostport":"eoshome-i03.cern.ch","remotemountdir":"/eos/user/","bind":"b e m v x","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.home-i04.conf: |
      {"name":"home-i04","hostport":"eoshome-i04.cern.ch","remotemountdir":"/eos/user/","bind":"c f i p q u","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.lhcb.conf: |
      {"name":"lhcb","hostport":"eoslhcb.cern.ch","remotemountdir":"/eos/lhcb/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.media.conf: |
      {"name":"media","hostport":"eosmedia.cern.ch","remotemountdir":"/eos/media/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.project-i00.conf: |
      {"name":"project-i00","hostport":"eosproject-i00.cern.ch","remotemountdir":"/eos/project/","bind":"a e j g v k q y","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.project-i01.conf: |
      {"name":"project-i01","hostport":"eosproject-i01.cern.ch","remotemountdir":"/eos/project/","bind":"l h b p s f w n o","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.project-i02.conf: |
      {"name":"project-i02","hostport":"eosproject-i02.cern.ch","remotemountdir":"/eos/project/","bind":"d c i r m t u x z","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.theory.conf: |
      {"name":"theory","hostport":"eospublic.cern.ch","remotemountdir":"/eos/theory/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.web.conf: |
      {"name":"web","hostport":"eosmedia.cern.ch","remotemountdir":"/eos/web/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.workspace.conf: |
      {"name":"workspace","hostport":"eospublic.cern.ch","remotemountdir":"/eos/workspace/","auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.user.conf: |
      {"name":"user","hostport":"eosuser-fuse.cern.ch","remotemountdir":"/eos/user/","rm-rf-protect-levels":2,"auth":{"ssskeytab":"/etc/eos.keytab"}}
    fuse.project.conf: |
      {"name":"project","hostport":"eosproject-fuse.cern.ch","remotemountdir":"/eos/project/","rm-rf-protect-levels":1,"auth":{"ssskeytab":"/etc/eos.keytab"}}

# CSI Node plugin DaemonSet configuration.
# Node plugin handles node-local operations, e.g. mounting and unmounting
# eosxd repositories.
nodeplugin:

  # Component name. Used as `component` label value
  # and to generate DaemonSet name.
  name: nodeplugin

  # Extra volumes to be appended to nodeplugin's Pod.spec.volumes.
  extraVolumes:
  - name: host-var-eos
    hostPath:
      path: /var/eos
      type: DirectoryOrCreate
  - name: host-var-cache
    hostPath:
      path: /var/cache
  - name: etc-eos
    configMap:
      name: eos-csi-dir-etc-eos
  - name: etc-auto-eos
    configMap:
      name: eos-csi-file-etc-auto-eos
  - name: etc-auto-master-d
    configMap:
      name: eos-csi-dir-etc-auto-master-d
  - name: etc-eos-keytab
    secret:
      secretName: eos-csi-file-etc-eos-keytab
      defaultMode: 0400

  # eosxd CSI image and container resources specs.
  plugin:
    image:
      repository: registry.cern.ch/kubernetes/eosxd-csi
      tag: latest
      pullPolicy: IfNotPresent
    resources: {}
    # Extra volume mounts to append to nodeplugin's
    # Pod.spec.containers[name="nodeplugin"].volumeMounts.
    extraVolumeMounts:
    - name: host-var-eos
      mountPath: /eos
      mountPropagation: Bidirectional

  # eosxd CSI image and container resources specs.
  automount:
    image:
      repository: registry.cern.ch/kubernetes/eosxd-csi
      tag: latest
      pullPolicy: IfNotPresent
    resources: {}
    # Extra volume mounts to append to nodeplugin's
    # Pod.spec.containers[name="automount"].volumeMounts.
    extraVolumeMounts:
    - name: host-var-eos
      mountPath: /eos
      mountPropagation: Bidirectional
    - name: host-var-cache
      mountPath: /var/cache
    - name: etc-eos
      mountPath: /etc/eos
    - name: etc-auto-eos
      mountPath: /etc/auto.eos
      subPath: auto.eos
    - name: etc-auto-master-d
      mountPath: /etc/auto.master.d
    - name: etc-eos-keytab
      mountPath: /etc/eos.keytab
      subPath: eos.keytab

  mountreconciler:
    image:
      repository: registry.cern.ch/kubernetes/eosxd-csi
      tag: latest
      pullPolicy: IfNotPresent
    resources: {}
    # Extra volume mounts to append to nodeplugin's
    # Pod.spec.containers[name="mountreconciler"].volumeMounts.
    extraVolumeMounts:
    - name: host-var-eos
      mountPath: /eos
      mountPropagation: Bidirectional

  # csi-node-driver-registrar image and container resources specs.
  registrar:
    image:
      repository: registry.k8s.io/sig-storage/csi-node-driver-registrar
      tag: v2.5.1
      pullPolicy: IfNotPresent
    resources: {}

  # DaemonSet update strategy.
  updateStrategySpec:
    # When eosxd Node plugin Pod is restarted, all existing eosxd mounts on
    # that node will break. If the Node plugin DaemonSet needs to be updated,
    # all Pods that mount eosxd volumes on that node must be restarted (deleted)
    # too in order to refresh the mounts.
    type: OnDelete

  # Pod priority class name.
  priorityClassName: system-node-critical

  # Pod node selector.
  nodeSelector: {}

  # Pod node tolerations.
  tolerations: []

  # Pod node affinity.
  affinity: {}

  # Pod's hostname must match the name of the host,
  # otherwise SSS reports "IP address mismatch".
  # This must be enabled when using OAuth2-based auth,
  # as it relies on SSS.
  hostNetwork: true

# CSI Controller plugin Deployment configuration.
# eosxd CSI supports volume provisioning, however the provisioned volumes only fulfill the role
# of a reference to eosxd repositories used inside the CO (e.g. Kubernetes), and are not modifying
# the eosxd store in any way.
controllerplugin:

  # Component name. Used as `component` label value
  # and to generate DaemonSet name.
  name: controllerplugin

  # Number of Deployment replicas. In general, one is sufficient.
  replicas: 1

  extraVolumes: []

  # eosxd CSI image and container resources specs.
  plugin:
    image:
      repository: registry.cern.ch/kubernetes/eosxd-csi
      tag: latest
      pullPolicy: IfNotPresent
    resources: {}
    extraVolumeMounts: []

  # CSI external-provisioner image and container resources specs.
  provisioner:
    image:
      repository: k8s.gcr.io/sig-storage/csi-provisioner
      tag: v3.2.1
      pullPolicy: IfNotPresent
    resources: {}

  # Deployment update strategy.
  deploymentStrategySpec:
    type: RollingUpdate

  # Pod priority class name.
  priorityClassName: ""

  # Pod node selector.
  nodeSelector: {}

  # Pod node tolerations.
  tolerations: []

  # Pod node affinity.
  affinity: {}

  # ServiceAccount to use with Controller plugin Deployment.
  serviceAccount:

    # Name of the ServiceAccount (to use and/or create).
    # If no name is provided, Helm chart will generate one.
    serviceAccountName: ""

    # Whether to create ServiceAccount in the eosxd CSI namespace.
    # If not, it is expected the ServiceAccount is already present.
    create: true

  # RBAC rules assigned to the ServiceAccount defined above.
  rbac:

    # Whether to create RBACs in the eosxd CSI namespace.
    # If not, it is expected they are already present.
    create: true

# Log verbosity level.
# See https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md
# for description of individual verbosity levels.
logVerbosityLevel: 4

# eosxd CSI driver name used as driver identifier by Kubernetes.
# Must follow DNS notation format (https://tools.ietf.org/html/rfc1035#section-2.3.1),
# and must be 63 characters or less.
csiDriverName: eosxd.csi.cern.ch

# Kubelet's plugin directory path. By default, kubelet uses /var/lib/kubelet/plugins.
# This value may need to be changed if kubelet's root dir (--root-dir) differs from
# this default path.
kubeletDirectory: /var/lib/kubelet

# Name of the eosxd CSI socket file. eosxd CSI socket file will be stored under
# <kubeletPluginDirectory>/plugins/<csiDriverName>/<csiPluginSocketFile>.
csiPluginSocketFile: csi.sock

# Number of seconds to wait for automount daemon to start up before exiting.
automountDaemonStartupTimeout: 10
# Number of seconds of idle time after which an autofs-managed eosxd mount will
# be unmounted. '0' means never unmount, '-1' leaves automount default option.
automountDaemonUnmountTimeout: 30

# Reconcile broken /eos/* mounts in specified interval.
reconcileMountsFrequency: 10s

# Chart name overrides.
nameOverride: ""
fullNameOverride: ""

# Extra Kubernetes object metadata labels to be added the ones generated
# with eosxd-csi.common.metaLabels template.
extraMetaLabels: {}
